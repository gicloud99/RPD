name: RDP Windows (Cloudflare Tunnel)

on:
  workflow_dispatch:

jobs:
  rdp-windows:
    runs-on: windows-latest
    timeout-minutes: 360
    
    # C·∫§U H√åNH T√äN V√Ä M·∫¨T KH·∫®U ·ªû ƒê√ÇY
    env:
      RDP_USERNAME: "UserAdmin"
      RDP_PASSWORD: "Password123!" 

    steps:
      # 1. T·∫°o User v√† B·∫≠t RDP
      - name: Setup User & RDP
        shell: pwsh
        run: |
          $u = $env:RDP_USERNAME
          $p = $env:RDP_PASSWORD
          $s = ConvertTo-SecureString $p -AsPlainText -Force

          # T·∫°o user
          New-LocalUser -Name $u -Password $s -Description "GitHub Action" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member $u
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u

          # B·∫≠t RDP, T·∫Øt NLA (ƒë·ªÉ d·ªÖ login), M·ªü Firewall
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes
          Write-Host "User & RDP setup complete."

      # 2. T·∫£i v√† ch·∫°y Cloudflared
      - name: Start Cloudflare Tunnel
        shell: pwsh
        run: |
          # T·∫£i tool
          Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"
          
          # Ch·∫°y ng·∫ßm v√† ghi log ra file cf.log
          Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url tcp://localhost:3389" -RedirectStandardError "cf.log" -PassThru
          Write-Host "Cloudflare tunnel started..."

      # 3. L·∫•y link v√† IN RA M√ÄN H√åNH (Ph·∫ßn b·∫°n c·∫ßn)
      - name: üëâ GET LOGIN INFO üëà
        shell: pwsh
        run: |
          $found = $false
          Write-Host "Dang lay dia chi ket noi..."
          
          # V√≤ng l·∫∑p ƒë·ª£i link xu·∫•t hi·ªán trong 30 gi√¢y
          for ($i = 0; $i -lt 30; $i++) {
            if (Test-Path "cf.log") {
              $log = Get-Content "cf.log" -Raw
              # T√¨m d√≤ng c√≥ d·∫°ng tcp://....trycloudflare.com:1234
              if ($log -match "tcp://([-a-z0-9.]+\.trycloudflare\.com:[0-9]+)") {
                $address = $matches[1] # L·∫•y ph·∫ßn ƒë·ªãa ch·ªâ (b·ªè ch·ªØ tcp://)
                
                # --- IN RA M√ÄN H√åNH TH·∫¨T TO ---
                Write-Host "`n`n"
                Write-Host "#######################################################" -ForegroundColor Green
                Write-Host "#                                                     #" -ForegroundColor Green
                Write-Host "#              THONG TIN DANG NHAP RDP                #" -ForegroundColor Green
                Write-Host "#                                                     #" -ForegroundColor Green
                Write-Host "#######################################################" -ForegroundColor Green
                Write-Host ""
                Write-Host "   üñ•Ô∏è  Computer (Address):  $address" -ForegroundColor Cyan
                Write-Host "   üë§  Username:            $env:RDP_USERNAME" -ForegroundColor Yellow
                Write-Host "   üîë  Password:            $env:RDP_PASSWORD" -ForegroundColor Yellow
                Write-Host ""
                Write-Host "#######################################################" -ForegroundColor Green
                Write-Host "Copy d√≤ng 'Computer' d√°n v√†o Remote Desktop Connection"
                Write-Host "`n`n"
                
                # In ra th√¥ng b√°o c·ªßa Github (Notice)
                echo "::notice title=RDP INFO::Address: $address | User: $env:RDP_USERNAME | Pass: $env:RDP_PASSWORD"
                
                $found = $true
                break
              }
            }
            Start-Sleep -Seconds 1
          }
          
          if (-not $found) {
            Write-Error "Khong lay ƒë∆∞·ª£c link Cloudflare. Vui l√≤ng th·ª≠ l·∫°i!"
            Get-Content "cf.log"
          }

      # 4. Gi·ªØ m√°y ch·∫°y
      - name: Keep Alive
        shell: pwsh
        run: |
          Write-Host "RDP is running. Don't close this tab."
          while ($true) { Start-Sleep -Seconds 60 }
