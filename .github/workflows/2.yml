name: RDP Windows (Cloudflare No-Key)

on:
  workflow_dispatch:

jobs:
  rdp-cloudflare:
    runs-on: windows-latest
    timeout-minutes: 360
    env:
      # Đặt Username và Password trực tiếp ở đây hoặc dùng Secrets
      # Nếu sợ lộ pass thì nên dùng ${{ secrets.RDP_PASSWORD }}
      RDP_USERNAME: "AdminUser"
      RDP_PASSWORD: "Password123@" 

    steps:
      # 1. Cấu hình User và Mật khẩu
      - name: Create User & Enable RDP
        shell: pwsh
        run: |
          $u = $env:RDP_USERNAME
          $p = $env:RDP_PASSWORD
          $s = ConvertTo-SecureString $p -AsPlainText -Force

          # Tạo user mới nếu chưa có
          if (-not (Get-LocalUser -Name $u -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $u -Password $s -AccountNeverExpires -Description "GitHub Action User"
          } else {
              Set-LocalUser -Name $u -Password $s
          }

          # Cấp quyền Admin và RDP
          Add-LocalGroupMember -Group "Administrators" -Member $u
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          
          # Bật RDP và tắt NLA (Quan trọng để dễ login)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          
          # Mở Firewall
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes
          Write-Host "User $u created and RDP enabled."

      # 2. Cài đặt Cloudflared
      - name: Install Cloudflared
        shell: pwsh
        run: |
          Write-Host "Downloading Cloudflared..."
          Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"
          Write-Host "Cloudflared downloaded."

      # 3. Chạy Tunnel (Đây là bước quan trọng nhất)
      - name: Start Tunnel
        shell: pwsh
        run: |
          Write-Host "Starting Cloudflare Tunnel..."
          # Chạy cloudflared và đẩy log ra file để lấy link
          Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url tcp://localhost:3389" -RedirectStandardError "cloudflared.log" -PassThru
          
          # Đợi một chút để lấy link
          Start-Sleep -Seconds 10
          
          # Đọc file log và tìm đường dẫn trycloudflare
          $logContent = Get-Content "cloudflared.log"
          $tunnelUrl = $logContent | Select-String -Pattern "tcp://.*\.trycloudflare\.com:\d+"
          
          if ($tunnelUrl) {
              Write-Host "`n========================================================"
              Write-Host "   KẾT NỐI THÀNH CÔNG!"
              Write-Host "   Copy dòng dưới đây vào Remote Desktop Connection:"
              Write-Host "   $tunnelUrl"
              Write-Host "   Username: $env:RDP_USERNAME"
              Write-Host "   Password: $env:RDP_PASSWORD"
              Write-Host "========================================================`n"
          } else {
              Write-Host "Đang tìm URL... Vui lòng kiểm tra file log hoặc đợi thêm."
              Get-Content "cloudflared.log" -Tail 20
          }

      # 4. Giữ kết nối sống (Anti-exit)
      - name: Keep Alive
        shell: pwsh
        run: |
          Write-Host "RDP is running. Check the step above for the address."
          while ($true) {
            Start-Sleep -Seconds 60
            # In lại log định kỳ phòng trường hợp link bị trôi
            $logContent = Get-Content "cloudflared.log"
            $urlMatches = $logContent | Select-String -Pattern "tcp://.*\.trycloudflare\.com:[0-9]+"
            if ($urlMatches) {
                 Write-Host "Current Address: $urlMatches"
            }
          }
