name: RDP Premium - Anh Dat Fixed

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      # 1. Cấu hình các thiết lập RDP cốt lõi và Firewall
      - name: Configure Core RDP Settings
        shell: pwsh
        run: |
          # Bật RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "Security Layer" -Value 0 -Force
          
          # Cấu hình Firewall cho RDP Port 3389
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          
          # Khởi động lại dịch vụ RDP
          Restart-Service -Name TermService -Force

      # 2. Tạo Tài khoản CỐ ĐỊNH cho Anh Đạt
      - name: Create Account for Anh Dat
        shell: pwsh
        run: |
          # Thông tin User/Pass Cố định
          $u = "Datlohehe"
          $p = "datlo@1234"
          
          # Mã hóa và tạo tài khoản cục bộ
          $s = ConvertTo-SecureString $p -AsPlainText -Force
          New-LocalUser -Name $u -Password $s -AccountNeverExpires -Description "GitHub RDP" -ErrorAction SilentlyContinue
          
          # Gán quyền Admin và Remote Desktop Users
          Add-LocalGroupMember -Group "Administrators" -Member $u
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          
          # LƯU MẬT KHẨU VÀO BIẾN MÔI TRƯỜNG MỚI: RDP_PASSWORD
          echo "RDP_PASSWORD=$p" >> $env:GITHUB_ENV
          Write-Host "✅ User: $u | Pass: $p"

      # 3. Cài đặt Tailscale (dùng MSI)
      - name: Install Tailscale
        shell: pwsh
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i `"$installerPath`" /quiet /norestart" -Wait
          Remove-Item $installerPath -Force

      # 4. Thiết lập Kết nối Tailscale
      - name: Establish Tailscale Connection
        shell: pwsh
        run: |
          # Sử dụng GITHUB_RUN_ID để tạo hostname duy nhất
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=Premium-AnhDat-$env:GITHUB_RUN_ID
          
          $tsIP = $null
          $retry = 0
          # Lặp để lấy IP Tailscale
          while (-not $tsIP -and $retry -lt 10) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            Start-Sleep -Seconds 5
            $retry++
          }
          
          if (-not $tsIP) { Write-Error "❌ Không lấy được IP Tailscale"; exit 1 }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "✅ IP Tailscale: $tsIP"

      # 5. Hiển thị Thông tin Đăng nhập cho Anh Đạt
      - name: Show RDP Access Info for Anh Dat
        shell: pwsh
        run: |
          $ip = $env:TAILSCALE_IP
          $pass = $env:RDP_PASSWORD
          
          Write-Host ""
          Write-Host "#######################################################" -ForegroundColor Green
          Write-Host "#           RDP ACCESS INFO FOR ANH DAT               #" -ForegroundColor Green
          Write-Host "#######################################################" -ForegroundColor Green
          Write-Host "Name: ANH DAT (RDP Premium)"
          Write-Host "Username: Datlohehe"
          Write-Host "Password: $pass"
          Write-Host "Tailscale IP: $ip"
          Write-Host "#######################################################"
          Write-Host ""

      # 6. Duy trì Phiên RDP
      - name: Maintain RDP Session (PREMIUM)
        shell: pwsh
        run: |
          Write-Host "[PREMIUM] RDP is running for Anh Dat..."
          # Lặp vô tận để giữ runner chạy, nghỉ 5 phút giữa các lần kiểm tra
          while ($true) {
            Start-Sleep -Seconds 300
          }
