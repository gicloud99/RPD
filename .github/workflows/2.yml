name: RDP Windows (Cloudflare Stable)

on: workflow_dispatch

jobs:
  rdp-stable:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      # 1. C√†i ƒë·∫∑t User & M√¥i tr∆∞·ªùng
      - name: Setup Environment
        shell: pwsh
        run: |
          # ƒê·∫∑t m·∫≠t kh·∫©u c·ª©ng ·ªü ƒë√¢y cho d·ªÖ nh·ªõ
          $user = "UserAdmin"
          $pass = "Password123!"
          
          # T·∫°o User
          $s = ConvertTo-SecureString $pass -AsPlainText -Force
          New-LocalUser -Name $user -Password $s -Description "GitHub Action" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member $user
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user
          
          # C·∫•u h√¨nh RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          
          # M·ªü Firewall
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes
          
          Write-Host "Da tao User: $user / Pass: $pass"

      # 2. Ch·∫°y Tunnel v√† Gi·ªØ k·∫øt n·ªëi (G·ªôp l√†m m·ªôt ƒë·ªÉ kh√¥ng bao gi·ªù m·∫•t link)
      - name: Start Tunnel & Keep Alive
        shell: pwsh
        run: |
          Write-Host "Dang tai Cloudflared..."
          Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"
          
          Write-Host "Dang khoi dong Tunnel..."
          # Ch·∫°y Cloudflare ng·∫ßm
          $process = Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url tcp://localhost:3389" -RedirectStandardError "cf.log" -PassThru
          
          # V√≤ng l·∫∑p v√¥ t·∫≠n ƒë·ªÉ gi·ªØ m√°y s·ªëng v√† in link li√™n t·ª•c
          while ($true) {
            Start-Sleep -Seconds 10
            
            if (Test-Path "cf.log") {
              $log = Get-Content "cf.log" -Raw
              # T√¨m link trycloudflare
              $matches = [regex]::Matches($log, "tcp://([-a-z0-9.]+\.trycloudflare\.com:[0-9]+)")
              
              if ($matches.Count -gt 0) {
                # L·∫•y k·∫øt qu·∫£ m·ªõi nh·∫•t
                $address = $matches[$matches.Count - 1].Groups[1].Value
                
                Clear-Host
                Write-Host "`n=============================================" -ForegroundColor Green
                Write-Host "       TRANG THAI: DANG CHAY (ONLINE)"
                Write-Host "=============================================" -ForegroundColor Green
                Write-Host "   üñ•Ô∏è  Computer:  $address" -ForegroundColor Cyan
                Write-Host "   üë§  Username:  UserAdmin" -ForegroundColor Yellow
                Write-Host "   üîë  Password:  Password123!" -ForegroundColor Yellow
                Write-Host "=============================================" -ForegroundColor Green
                Write-Host "Dang giu ket noi... (Dung tat tab nay)"
              } else {
                Write-Host "Dang cho Cloudflare cap link... Vui long doi..."
              }
            }
            
            # Ki·ªÉm tra xem ti·∫øn tr√¨nh Cloudflare c√≤n ch·∫°y kh√¥ng
            if ($process.HasExited) {
               Write-Error "Cloudflare tunnel da bi tat dot ngot. Dang khoi dong lai..."
               $process = Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url tcp://localhost:3389" -RedirectStandardError "cf.log" -PassThru
            }
          }
