name: RDP Windows (Bore Alternative)

on: workflow_dispatch

jobs:
  rdp-bore:
    runs-on: windows-latest
    steps:
      - name: Setup RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes
          $p = ConvertTo-SecureString "Password123!" -AsPlainText -Force
          New-LocalUser "UserAdmin" -Password $p -Description "RDP"
          Add-LocalGroupMember "Administrators" "UserAdmin"
          Add-LocalGroupMember "Remote Desktop Users" "UserAdmin"

      - name: Start Bore Tunnel
        shell: pwsh
        run: |
          # Tải Bore
          Invoke-WebRequest "https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-pc-windows-msvc.zip" -OutFile "bore.zip"
          Expand-Archive "bore.zip" -DestinationPath "."
          
          # Chạy Bore
          Start-Process -FilePath ".\bore.exe" -ArgumentList "local 3389 --to bore.pub" -RedirectStandardOutput "bore.log" -PassThru
          
          Write-Host "Dang lay dia chi..."
          Start-Sleep -Seconds 5
          
          # Lấy Port
          $log = Get-Content "bore.log" -Raw
          if ($log -match "bore.pub:(\d+)") {
            $port = $matches[1]
            Write-Host "`n========================================" -ForegroundColor Green
            Write-Host "   Computer: bore.pub:$port" -ForegroundColor Cyan
            Write-Host "   User:     UserAdmin" -ForegroundColor Yellow
            Write-Host "   Pass:     Password123!" -ForegroundColor Yellow
            Write-Host "========================================`n"
          } else {
            Get-Content "bore.log"
          }

      - name: Keep Alive
        run: while($true) { Start-Sleep 60 }
