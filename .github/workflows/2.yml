name: RDP Windows (Fixed Timeout)

on:
  workflow_dispatch:

jobs:
  rdp-windows:
    runs-on: windows-latest
    timeout-minutes: 360
    
    env:
      RDP_USERNAME: "UserAdmin"
      RDP_PASSWORD: "Password123!" 

    steps:
      # 1. C√†i ƒë·∫∑t User & RDP
      - name: Setup User & RDP
        shell: pwsh
        run: |
          $u = $env:RDP_USERNAME
          $p = $env:RDP_PASSWORD
          $s = ConvertTo-SecureString $p -AsPlainText -Force
          New-LocalUser -Name $u -Password $s -Description "GitHub Action" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member $u
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes
          Write-Host "User & RDP setup complete."

      # 2. Ch·∫°y Tunnel
      - name: Start Cloudflare Tunnel
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"
          Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url tcp://localhost:3389" -RedirectStandardError "cf.log" -PassThru
          Write-Host "Cloudflare dang khoi dong..."

      # 3. L·∫•y link (ƒê√£ tƒÉng th·ªùi gian ch·ªù & fix l·ªói)
      - name: üëâ GET LOGIN INFO üëà
        shell: pwsh
        run: |
          $found = $false
          Write-Host "Dang cho Cloudflare cap link (Toi da 3 phut)..."
          
          # TƒÉng v√≤ng l·∫∑p l√™n 180 l·∫ßn (m·ªói l·∫ßn 1 gi√¢y = 3 ph√∫t)
          for ($i = 0; $i -lt 180; $i++) {
            if (Test-Path "cf.log") {
              $log = Get-Content "cf.log" -Raw
              if ($log -match "tcp://([-a-z0-9.]+\.trycloudflare\.com:[0-9]+)") {
                $address = $matches[1]
                
                Write-Host "`n`n#######################################################" -ForegroundColor Green
                Write-Host "#              THONG TIN DANG NHAP RDP                #" -ForegroundColor Green
                Write-Host "#######################################################" -ForegroundColor Green
                Write-Host ""
                Write-Host "   üñ•Ô∏è  Computer:   $address" -ForegroundColor Cyan
                Write-Host "   üë§  Username:   $env:RDP_USERNAME" -ForegroundColor Yellow
                Write-Host "   üîë  Password:   $env:RDP_PASSWORD" -ForegroundColor Yellow
                Write-Host ""
                Write-Host "#######################################################`n`n"
                
                $found = $true
                break
              }
            }
            # C·ª© 10 gi√¢y in d·∫•u ch·∫•m 1 l·∫ßn cho bi·∫øt ƒëang ch·∫°y
            if ($i % 10 -eq 0) { Write-Host -NoNewline "." }
            Start-Sleep -Seconds 1
          }
          
          if (-not $found) {
            Write-Error "‚ö†Ô∏è KHONG LAY DUOC LINK! DUOI DAY LA LOI TU CLOUDFLARE:"
            Write-Host "---------------------------------------------------"
            Get-Content "cf.log"
            Write-Host "---------------------------------------------------"
            exit 1
          }

      # 4. Gi·ªØ m√°y ch·∫°y
      - name: Keep Alive
        shell: pwsh
        run: |
          Write-Host "RDP Running..."
          while ($true) { Start-Sleep -Seconds 60 }
