name: RDP Moonlight (Full Choco Fixed)

on:
  workflow_dispatch:

jobs:
  moonlight-choco:
    runs-on: windows-latest
    timeout-minutes: 360
    env:
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}

    steps:
      # 1. Kiá»ƒm tra Secret
      - name: Check Key
        shell: pwsh
        run: if (-not $env:TAILSCALE_AUTH_KEY) { Write-Error "âŒ Thieu TAILSCALE_AUTH_KEY"; exit 1 }

      # 2. CÃ i Tailscale & Sunshine & ViGEmBus (Táº¤T Cáº¢ Báº°NG CHOCO)
      - name: Install Softwares (Choco)
        shell: pwsh
        run: |
          Write-Host "â³ Dang cai dat toan bo phan mem..."
          # CÃ i má»™t lÃ¨o 3 cÃ¡i luÃ´n cho nhanh vÃ  khÃ´ng lo link cháº¿t
          choco install tailscale vigembus sunshine -y --no-progress --force
          
          Write-Host "âœ… Cai dat xong: Tailscale, Driver Tay cam, Sunshine."

      # 3. Káº¿t ná»‘i Tailscale
      - name: Connect Tailscale
        shell: pwsh
        run: |
          Write-Host "â³ Dang ket noi VPN..."
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname="github-moonlight" --unattended --reset
          
          # Láº¥y IP (Thá»­ 20 láº§n)
          $tsIP = $null
          for ($i=0; $i -lt 20; $i++) {
            $tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
            if ($tsIP) { break }
            Start-Sleep 2
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "âœ… IP Tailscale: $tsIP"

      # 4. CÃ i Virtual Display (MÃ n hÃ¬nh áº£o)
      - name: Install Virtual Display
        shell: pwsh
        run: |
          Write-Host "â³ Dang tai Man hinh ao..."
          # ThÃªm UserAgent Ä‘á»ƒ khÃ´ng bá»‹ cháº·n táº£i
          Invoke-WebRequest "https://www.amyuni.com/downloads/usbmmidd_v2.zip" -OutFile "usbmmidd.zip" -UserAgent "Mozilla/5.0"
          
          Write-Host "â³ Giai nen..."
          Expand-Archive "usbmmidd.zip" -DestinationPath "C:\TempVD" -Force
          
          # Tá»± tÃ¬m file exe cÃ i Ä‘áº·t
          $installer = Get-ChildItem -Path "C:\TempVD" -Filter "deviceinstaller64.exe" -Recurse | Select-Object -First 1
          Set-Location -Path $installer.DirectoryName
          
          Write-Host "â³ Dang cai driver man hinh..."
          & .\deviceinstaller64.exe install usbmmidd.inf usbmmidd
          & .\deviceinstaller64.exe enableidd 1
          Write-Host "âœ… Da tao man hinh 1920x1080"

      # 5. Báº­t Sunshine & Cáº¥u hÃ¬nh Firewall
      - name: Start Sunshine
        shell: pwsh
        run: |
          # Má»Ÿ Port
          netsh advfirewall firewall add rule name="Sunshine Web" dir=in action=allow protocol=TCP localport=47990
          netsh advfirewall firewall add rule name="Sunshine Stream" dir=in action=allow protocol=TCP localport=47984-48010
          netsh advfirewall firewall add rule name="Sunshine UDP" dir=in action=allow protocol=UDP localport=47998-48010
          
          # Cháº¡y Sunshine
          $sunshine = "C:\Program Files\Sunshine\Sunshine.exe"
          if (Test-Path $sunshine) {
            Start-Process -FilePath $sunshine -WorkingDirectory "C:\Program Files\Sunshine"
            Write-Host "âœ… Sunshine da chay!"
          } else {
            Write-Error "âŒ Khong tim thay Sunshine!"
          }

      # 6. Báº­t RDP dá»± phÃ²ng
      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes

      # 7. Táº¡o User/Pass Cá» Äá»ŠNH
      - name: Create User
        shell: pwsh
        run: |
          $u = "UserAdmin"
          $p = "datlo@1234"
          $s = ConvertTo-SecureString $p -AsPlainText -Force
          New-LocalUser -Name $u -Password $s -AccountNeverExpires -Description "GitHub" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member $u
          Write-Host "âœ… User: $u | Pass: $p"

      # 8. HÆ¯á»šNG DáºªN
      - name: ðŸ‘‰ LOGIN INFO ðŸ‘ˆ
        shell: pwsh
        run: |
          $ip = $env:TAILSCALE_IP
          
          Write-Host "`n`n"
          Write-Host "#######################################################" -ForegroundColor Green
          Write-Host "#           HUONG DAN KET NOI MOONLIGHT               #" -ForegroundColor Green
          Write-Host "#######################################################" -ForegroundColor Green
          Write-Host ""
          Write-Host "   1. Tren dien thoai: Bat App Tailscale."
          Write-Host "   2. Vao trinh duyet: https://$($ip):47990" -ForegroundColor Cyan
          Write-Host "      (User/Pass tao moi la: admin / admin)"
          Write-Host "   3. Lay PIN tu Moonlight -> Nhap vao web."
          Write-Host ""
          Write-Host "   --- TAI KHOAN WINDOWS ---"
          Write-Host "   User: UserAdmin"
          Write-Host "   Pass: datlo@1234"
          Write-Host "#######################################################`n`n"
          
          while ($true) { Start-Sleep 60 }
