name: RDP Moonlight + Tailscale (Fixed Pass)

on:
  workflow_dispatch:

jobs:
  moonlight-tailscale:
    runs-on: windows-latest
    timeout-minutes: 360
    env:
      # Chá»‰ cáº§n Ä‘Ãºng 1 Secret nÃ y trong Settings cá»§a GitHub
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}

    steps:
      # 1. Kiá»ƒm tra Secret
      - name: Check Key
        shell: pwsh
        run: |
          if (-not $env:TAILSCALE_AUTH_KEY) { Write-Error "âŒ Thieu TAILSCALE_AUTH_KEY"; exit 1 }

      # 2. CÃ i Ä‘áº·t Tailscale & Káº¿t ná»‘i
      - name: Install & Connect Tailscale
        shell: pwsh
        run: |
          Write-Host "Cai dat Tailscale..."
          choco install tailscale -y --no-progress --force
          
          Write-Host "Dang ket noi..."
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname="github-moonlight" --unattended --reset
          
          # Láº¥y IP
          $tsIP = $null
          for ($i=0; $i -lt 20; $i++) {
            $tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
            if ($tsIP) { break }
            Start-Sleep 2
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "âœ… IP Tailscale: $tsIP"

      # 3. CÃ i ViGEmBus (Driver tay cáº§m áº£o cho Moonlight)
      - name: Install ViGEmBus
        shell: pwsh
        run: |
          Write-Host "Cai dat Driver Tay cam..."
          Invoke-WebRequest "https://github.com/ViGEm/ViGEmBus/releases/download/v1.21.442.0/ViGEmBus_Setup_1.21.442_x64.msi" -OutFile "ViGEmBus.msi"
          Start-Process msiexec.exe -ArgumentList "/i ViGEmBus.msi /quiet /norestart" -Wait

      # 4. CÃ i Virtual Display (MÃ n hÃ¬nh áº£o - Quan trá»ng Ä‘á»ƒ cÃ³ hÃ¬nh áº£nh)
      - name: Install Virtual Display
        shell: pwsh
        run: |
          Write-Host "Tao Man hinh ao..."
          Invoke-WebRequest "https://www.amyuni.com/downloads/usbmmidd_v2.zip" -OutFile "usbmmidd.zip"
          Expand-Archive "usbmmidd.zip" -DestinationPath "C:\usbmmidd"
          cd "C:\usbmmidd"
          & .\deviceinstaller64.exe install usbmmidd.inf usbmmidd
          & .\deviceinstaller64.exe enableidd 1
          Write-Host "âœ… Da tao man hinh 1920x1080"

      # 5. CÃ i Sunshine (Server cho Moonlight)
      - name: Install Sunshine
        shell: pwsh
        run: |
          Write-Host "Tai Sunshine..."
          Invoke-WebRequest "https://github.com/LizardByte/Sunshine/releases/latest/download/sunshine-windows-installer.exe" -OutFile "sunshine_setup.exe"
          Write-Host "Cai Sunshine..."
          Start-Process -FilePath ".\sunshine_setup.exe" -ArgumentList "/S" -Wait
          
          # Má»Ÿ Firewall cho Sunshine
          netsh advfirewall firewall add rule name="Sunshine Web" dir=in action=allow protocol=TCP localport=47990
          netsh advfirewall firewall add rule name="Sunshine Stream" dir=in action=allow protocol=TCP localport=47984-48010
          netsh advfirewall firewall add rule name="Sunshine UDP" dir=in action=allow protocol=UDP localport=47998-48010

      # 6. Báº­t RDP & Sunshine
      - name: Start Services
        shell: pwsh
        run: |
          # Báº­t Sunshine
          Start-Process -FilePath "C:\Program Files\Sunshine\Sunshine.exe" -WorkingDirectory "C:\Program Files\Sunshine"
          
          # Báº­t RDP (Ä‘á»ƒ dá»± phÃ²ng)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes

      # 7. Táº¡o User/Pass Cá» Äá»ŠNH
      - name: Create User
        shell: pwsh
        run: |
          $u = "UserAdmin"
          $p = "datlo@1234"
          $s = ConvertTo-SecureString $p -AsPlainText -Force
          New-LocalUser -Name $u -Password $s -AccountNeverExpires -Description "GitHub" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member $u
          Write-Host "âœ… User: $u | Pass: $p"

      # 8. IN HÆ¯á»šNG DáºªN Sá»¬ Dá»¤NG
      - name: ðŸ‘‰ LOGIN INFO ðŸ‘ˆ
        shell: pwsh
        run: |
          $ip = $env:TAILSCALE_IP
          
          Write-Host "`n`n"
          Write-Host "#######################################################" -ForegroundColor Green
          Write-Host "#           HUONG DAN KET NOI (MOONLIGHT)             #" -ForegroundColor Green
          Write-Host "#######################################################" -ForegroundColor Green
          Write-Host ""
          Write-Host "   1. Tren dien thoai: Bat App Tailscale (VPN) len."
          Write-Host "   2. Mo trinh duyet web, vao trang quan ly:"
          Write-Host "      ðŸ‘‰ https://$($ip):47990" -ForegroundColor Cyan
          Write-Host "      (Neu bao loi bao mat -> Chon 'Nang cao' -> 'Tiep tuc')"
          Write-Host ""
          Write-Host "   3. Tai khoan quan ly Sunshine (Login xong cu de do):"
          Write-Host "      User: admin" -ForegroundColor Yellow
          Write-Host "      Pass: admin" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "   4. Mo App Moonlight (hoac Artemis):"
          Write-Host "      - Them PC voi IP: $ip"
          Write-Host "      - No hien cai MA PIN (Vi du: 1234)"
          Write-Host ""
          Write-Host "   5. Quay lai trang web Sunshine -> Tab 'PIN' -> Nhap ma PIN -> Enter."
          Write-Host ""
          Write-Host "   --- THONG TIN WINDOWS (Neu can) ---"
          Write-Host "   User: UserAdmin"
          Write-Host "   Pass: datlo@1234"
          Write-Host "#######################################################`n`n"
          
          while ($true) { Start-Sleep 60 }
