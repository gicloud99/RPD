name: RDP Windows (Tailscale Fixed)

on:
  workflow_dispatch:

jobs:
  rdp-tailscale:
    runs-on: windows-latest
    timeout-minutes: 360
    env:
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      RDP_USERNAME: ${{ secrets.RDP_USERNAME }}
      RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}

    steps:
      # 1. Ki·ªÉm tra xem ƒë√£ nh·∫≠p Secret ch∆∞a
      - name: Check Secrets
        shell: pwsh
        run: |
          if (-not $env:TAILSCALE_AUTH_KEY) { Write-Error "‚ùå L·ªói: Ch∆∞a c√≥ TAILSCALE_AUTH_KEY trong Settings > Secrets"; exit 1 }
          if (-not $env:RDP_USERNAME) { Write-Error "‚ùå L·ªói: Ch∆∞a c√≥ RDP_USERNAME"; exit 1 }
          if (-not $env:RDP_PASSWORD) { Write-Error "‚ùå L·ªói: Ch∆∞a c√≥ RDP_PASSWORD"; exit 1 }
          Write-Host "‚úÖ ƒê√£ t√¨m th·∫•y ƒë·∫ßy ƒë·ªß Secrets."

      # 2. C√†i ƒë·∫∑t Tailscale (D√πng b·∫£n ·ªïn ƒë·ªãnh)
      - name: Install Tailscale
        shell: pwsh
        run: |
          Write-Host "Dang cai dat Tailscale..."
          choco install tailscale -y --no-progress --force
          
          # Ki·ªÉm tra ƒë∆∞·ªùng d·∫´n file ch·∫°y
          $tsPath = "C:\Program Files\Tailscale\tailscale.exe"
          if (-not (Test-Path $tsPath)) {
              Write-Error "‚ùå C√†i ƒë·∫∑t th·∫•t b·∫°i. Kh√¥ng t√¨m th·∫•y file tailscale.exe"
              exit 1
          }
          Write-Host "‚úÖ C√†i ƒë·∫∑t th√†nh c√¥ng."

      # 3. K·∫øt n·ªëi Tailscale (Fix l·ªói IP)
      - name: Connect to Tailscale Network
        shell: pwsh
        run: |
          $tsExe = "C:\Program Files\Tailscale\tailscale.exe"
          
          Write-Host "Dang ket noi voi may chu Tailscale..."
          # Reset ƒë·ªÉ tr√°nh l·ªói c≈© v√† k·∫øt n·ªëi m·ªõi
          & $tsExe up --authkey=$env:TAILSCALE_AUTH_KEY --hostname="github-runner-win" --unattended --reset
          
          # V√≤ng l·∫∑p l·∫•y IP (Th·ª≠ l·∫°i 20 l·∫ßn thay v√¨ ch·ªâ ƒë·ª£i 5s)
          $tsIP = $null
          for ($i=0; $i -lt 20; $i++) {
            $tsIP = & $tsExe ip -4
            if ($tsIP) { break }
            Start-Sleep -Seconds 2
            Write-Host "Dang lay IP ($i)..."
          }
          
          if (-not $tsIP) { Write-Error "‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c IP Tailscale!"; exit 1 }
          
          # L∆∞u IP v√†o bi·∫øn m√¥i tr∆∞·ªùng ƒë·ªÉ b∆∞·ªõc sau d√πng
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "‚úÖ K·∫øt n·ªëi th√†nh c√¥ng! IP: $tsIP"

      # 4. C·∫•u h√¨nh RDP (T·∫Øt NLA tri·ªát ƒë·ªÉ)
      - name: Configure RDP & Firewall
        shell: pwsh
        run: |
          # B·∫≠t RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          
          # T·∫Øt NLA (Quan tr·ªçng: N·∫øu kh√¥ng t·∫Øt s·∫Ω r·∫•t kh√≥ login)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 1 -Force
          
          # M·ªü Firewall cho c·ªïng 3389
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes
          netsh advfirewall firewall add rule name="Tailscale-In" dir=in action=allow protocol=TCP localport=3389 profile=any
          
          Write-Host "‚úÖ ƒê√£ b·∫≠t RDP v√† T·∫Øt NLA."

      # 5. T·∫°o User Admin
      - name: Create User Account
        shell: pwsh
        run: |
          $u = $env:RDP_USERNAME
          $p = $env:RDP_PASSWORD
          $s = ConvertTo-SecureString $p -AsPlainText -Force

          # T·∫°o user n·∫øu ch∆∞a c√≥, update n·∫øu ƒë√£ c√≥
          if (-not (Get-LocalUser -Name $u -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $u -Password $s -AccountNeverExpires -Description "GitHub Action User"
          } else {
              Set-LocalUser -Name $u -Password $s
          }

          # C·∫•p quy·ªÅn Admin
          Add-LocalGroupMember -Group "Administrators" -Member $u
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          Write-Host "‚úÖ ƒê√£ t·∫°o User: $u"

      # 6. Hi·ªÉn th·ªã th√¥ng tin & Gi·ªØ k·∫øt n·ªëi
      - name: üëâ LOGIN INFO üëà
        shell: pwsh
        run: |
          $tsIP = $env:TAILSCALE_IP
          
          Write-Host "`n`n"
          Write-Host "#######################################################" -ForegroundColor Green
          Write-Host "#              THONG TIN KET NOI (TAILSCALE)          #" -ForegroundColor Green
          Write-Host "#######################################################" -ForegroundColor Green
          Write-Host ""
          Write-Host "   ‚ö†Ô∏è  YEU CAU: May cua ban phai cai Tailscale va da Login." -ForegroundColor Red
          Write-Host ""
          Write-Host "   üñ•Ô∏è  Tailscale IP:  $tsIP" -ForegroundColor Cyan
          Write-Host "   üë§  Username:      $env:RDP_USERNAME" -ForegroundColor Yellow
          Write-Host "   üîë  Password:      $env:RDP_PASSWORD" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "#######################################################" -ForegroundColor Green
          Write-Host "Copy IP tren va dan vao Remote Desktop Connection"
          Write-Host "`n`n"
          
          # V√≤ng l·∫∑p gi·ªØ m√°y s·ªëng
          while ($true) {
            Start-Sleep -Seconds 60
            Write-Host "RDP dang chay tai IP: $tsIP..."
          }
