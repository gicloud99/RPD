name: RDP Moonlight (Fixed Driver)

on:
  workflow_dispatch:

jobs:
  moonlight-auto:
    runs-on: windows-latest
    timeout-minutes: 360
    env:
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}

    steps:
      # 1. Kiá»ƒm tra Secret
      - name: Check Key
        shell: pwsh
        run: if (-not $env:TAILSCALE_AUTH_KEY) { Write-Error "âŒ Thieu TAILSCALE_AUTH_KEY"; exit 1 }

      # 2. CÃ i Tailscale & Láº¥y IP
      - name: Install & Connect Tailscale
        shell: pwsh
        run: |
          Write-Host "Cai dat Tailscale..."
          choco install tailscale -y --no-progress --force
          
          Write-Host "Dang ket noi..."
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname="github-moonlight" --unattended --reset
          
          # Láº¥y IP (Thá»­ 20 láº§n)
          $tsIP = $null
          for ($i=0; $i -lt 20; $i++) {
            $tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
            if ($tsIP) { break }
            Start-Sleep 2
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "âœ… IP Tailscale: $tsIP"

      # 3. CÃ i ViGEmBus (FIX: DÃ¹ng Choco Ä‘á»ƒ khÃ´ng bá»‹ lá»—i link)
      - name: Install ViGEmBus (Fixed)
        shell: pwsh
        run: |
          Write-Host "Dang cai Driver Tay cam bang Chocolatey..."
          choco install vigembus -y --no-progress
          Write-Host "âœ… Cai Driver Tay cam thanh cong."

      # 4. CÃ i Virtual Display (MÃ n hÃ¬nh áº£o)
      - name: Install Virtual Display
        shell: pwsh
        run: |
          Write-Host "Tao Man hinh ao..."
          Invoke-WebRequest "https://www.amyuni.com/downloads/usbmmidd_v2.zip" -OutFile "usbmmidd.zip"
          Expand-Archive "usbmmidd.zip" -DestinationPath "C:\usbmmidd"
          cd "C:\usbmmidd"
          & .\deviceinstaller64.exe install usbmmidd.inf usbmmidd
          & .\deviceinstaller64.exe enableidd 1
          Write-Host "âœ… Da tao man hinh 1920x1080"

      # 5. CÃ i Sunshine (Server Moonlight)
      - name: Install Sunshine
        shell: pwsh
        run: |
          Write-Host "Tai Sunshine..."
          Invoke-WebRequest "https://github.com/LizardByte/Sunshine/releases/latest/download/sunshine-windows-installer.exe" -OutFile "sunshine_setup.exe"
          
          Write-Host "Cai Sunshine..."
          Start-Process -FilePath ".\sunshine_setup.exe" -ArgumentList "/S" -Wait
          
          # Má»Ÿ Firewall
          netsh advfirewall firewall add rule name="Sunshine Web" dir=in action=allow protocol=TCP localport=47990
          netsh advfirewall firewall add rule name="Sunshine Stream" dir=in action=allow protocol=TCP localport=47984-48010
          netsh advfirewall firewall add rule name="Sunshine UDP" dir=in action=allow protocol=UDP localport=47998-48010

      # 6. Báº­t Sunshine & RDP
      - name: Start Services
        shell: pwsh
        run: |
          # Báº­t Sunshine
          Start-Process -FilePath "C:\Program Files\Sunshine\Sunshine.exe" -WorkingDirectory "C:\Program Files\Sunshine"
          
          # Báº­t RDP (Ä‘á»ƒ dá»± phÃ²ng)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes

      # 7. Táº¡o User/Pass Cá» Äá»ŠNH
      - name: Create User
        shell: pwsh
        run: |
          $u = "UserAdmin"
          $p = "datlo@1234"
          $s = ConvertTo-SecureString $p -AsPlainText -Force
          New-LocalUser -Name $u -Password $s -AccountNeverExpires -Description "GitHub" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member $u
          Write-Host "âœ… User: $u | Pass: $p"

      # 8. IN HÆ¯á»šNG DáºªN
      - name: ðŸ‘‰ LOGIN INFO ðŸ‘ˆ
        shell: pwsh
        run: |
          $ip = $env:TAILSCALE_IP
          
          Write-Host "`n`n"
          Write-Host "#######################################################" -ForegroundColor Green
          Write-Host "#           HUONG DAN KET NOI (MOONLIGHT)             #" -ForegroundColor Green
          Write-Host "#######################################################" -ForegroundColor Green
          Write-Host ""
          Write-Host "   1. Tren dien thoai: Bat App Tailscale (VPN) len."
          Write-Host "   2. Mo trinh duyet web, vao trang quan ly:"
          Write-Host "      ðŸ‘‰ https://$($ip):47990" -ForegroundColor Cyan
          Write-Host "      (Neu bao loi bao mat -> Chon 'Nang cao' -> 'Tiep tuc')"
          Write-Host ""
          Write-Host "   3. Tai khoan Sunshine:"
          Write-Host "      User: admin" -ForegroundColor Yellow
          Write-Host "      Pass: admin" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "   4. Mo App Moonlight/Artemis -> Add PC -> Lay ma PIN."
          Write-Host "   5. Nhap PIN vao trang web Sunshine -> XONG."
          Write-Host ""
          Write-Host "   --- KET NOI RDP (Neu can) ---"
          Write-Host "   App: RD Client"
          Write-Host "   User: UserAdmin"
          Write-Host "   Pass: datlo@1234"
          Write-Host "#######################################################`n`n"
          
          while ($true) { Start-Sleep 60 }
